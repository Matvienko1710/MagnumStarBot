"use strict";(()=>{var e={};e.id=899,e.ids=[899],e.modules={1185:e=>{e.exports=require("mongoose")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5519:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>y,patchFetch:()=>v,requestAsyncStorage:()=>c,routeModule:()=>g,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var o={};t.r(o),t.d(o,{GET:()=>p,POST:()=>d});var s=t(9303),n=t(8716),a=t(670),u=t(7070),l=t(2021),i=t(2690);async function d(e){try{let{telegramId:r,upgradeId:t,level:o}=await e.json();if(console.log("Upgrade API called with:",{telegramId:r,upgradeId:t,level:o}),!r||!t||void 0===o)return console.log("Missing required parameters"),u.NextResponse.json({error:"Missing required parameters"},{status:400});let s=parseInt(r);if(isNaN(s)||s<1e8||s>999999999)return console.log("Invalid Telegram ID format:",r),u.NextResponse.json({error:"Invalid Telegram ID format"},{status:400});await (0,l.Z)();let n=await i.Z.findOne({telegramId:s});if(!n)return console.log("User not found for upgrade"),u.NextResponse.json({error:"User not found"},{status:404});n.upgrades||(n.upgrades=[]);let a=n.upgrades.find(e=>e.id===t);switch(a||(a={id:t,level:0},n.upgrades.push(a)),a.level=o,t){case"click_power":n.clickPower=1+o;break;case"energy_capacity":n.maxEnergy=100+10*o,n.energy>n.maxEnergy&&(n.energy=n.maxEnergy)}return await n.save(),console.log("User upgrade saved:",{telegramId:n.telegramId,upgradeId:t,level:o}),u.NextResponse.json({success:!0,upgrade:{id:t,level:o}})}catch(e){return console.error("Error processing upgrade:",e),u.NextResponse.json({error:"Internal server error"},{status:500})}}async function p(e){try{let{searchParams:r}=new URL(e.url),t=r.get("telegramId");if(console.log("GET /api/upgrades called with telegramId:",t),!t)return console.log("No telegramId provided"),u.NextResponse.json({error:"Telegram ID is required"},{status:400});let o=parseInt(t);if(isNaN(o)||o<1e8||o>999999999)return console.log("Invalid Telegram ID format:",t),u.NextResponse.json({error:"Invalid Telegram ID format"},{status:400});await (0,l.Z)();let s=await i.Z.findOne({telegramId:o});if(!s)return console.log("User not found for upgrades"),u.NextResponse.json({error:"User not found"},{status:404});return u.NextResponse.json({success:!0,upgrades:s.upgrades||[]})}catch(e){return console.error("Error fetching upgrades:",e),u.NextResponse.json({error:"Internal server error"},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/upgrades/route",pathname:"/api/upgrades",filename:"route",bundlePath:"app/api/upgrades/route"},resolvedPagePath:"C:\\Users\\matvi\\OneDrive\\Рабочий стол\\MagnumStarBot-1\\app\\api\\upgrades\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:c,staticGenerationAsyncStorage:m,serverHooks:f}=g,y="/api/upgrades/route";function v(){return(0,a.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},2690:(e,r,t)=>{t.d(r,{Z:()=>a});var o=t(1185),s=t.n(o);let n=new o.Schema({telegramId:{type:Number,required:!0,unique:!0},username:{type:String},firstName:{type:String},lastName:{type:String},magnumCoins:{type:Number,default:0},stars:{type:Number,default:0},energy:{type:Number,default:100},maxEnergy:{type:Number,default:100},totalClicks:{type:Number,default:0},level:{type:Number,default:1},lastEnergyRestore:{type:Date,default:Date.now},clickPower:{type:Number,default:1},upgrades:[{id:{type:String,required:!0},level:{type:Number,default:0}}]},{timestamps:!0}),a=s().models.User||s().model("User",n)},2021:(e,r,t)=>{t.d(r,{Z:()=>u});var o=t(1185),s=t.n(o);let n=process.env.MONGODB_URI,a=!1,u=async function(){if(!n)return console.warn("MongoDB connection skipped - running in test mode"),null;if(a)return console.log("MongoDB already connected"),s();try{return await s().connect(n,{bufferCommands:!1,maxPoolSize:10,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3}),a=!0,console.log("MongoDB connected successfully"),s()}catch(e){throw console.error("MongoDB connection error:",e),a=!1,e}}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[276,972],()=>t(5519));module.exports=o})();