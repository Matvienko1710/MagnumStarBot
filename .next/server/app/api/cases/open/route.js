"use strict";(()=>{var e={};e.id=309,e.ids=[309],e.modules={1185:e=>{e.exports=require("mongoose")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7883:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>w,requestAsyncStorage:()=>x,routeModule:()=>f,serverHooks:()=>b,staticGenerationAsyncStorage:()=>N});var n={};r.r(n),r.d(n,{POST:()=>g});var a=r(9303),s=r(8716),i=r(670),m=r(7070),o=r(6039),u=r(2690),p=r(1185),d=r.n(p);let l=new p.Schema({userId:{type:Number,required:!0},caseType:{type:String,required:!0},caseName:{type:String,required:!0},price:{type:Number,required:!0},rewards:[{type:{type:String,enum:["coins","stars","energy"],required:!0},amount:{type:Number,required:!0}}],openedAt:{type:Date,default:Date.now}},{timestamps:!0}),y=d().models.Case||d().model("Case",l),c={bronze:{name:"Бронзовый кейс",price:100,rewards:[{type:"coins",min:50,max:200},{type:"stars",min:.001,max:.01}]},silver:{name:"Серебряный кейс",price:500,rewards:[{type:"coins",min:300,max:800},{type:"stars",min:.01,max:.05},{type:"energy",min:10,max:30}]},gold:{name:"Золотой кейс",price:1e3,rewards:[{type:"coins",min:800,max:2e3},{type:"stars",min:.05,max:.15},{type:"energy",min:20,max:50}]},platinum:{name:"Платиновый кейс",price:5e3,rewards:[{type:"coins",min:3e3,max:8e3},{type:"stars",min:.1,max:.5},{type:"energy",min:50,max:100}]},mythic:{name:"Мифический кейс",price:15e3,rewards:[{type:"coins",min:1e4,max:25e3},{type:"stars",min:.5,max:2},{type:"energy",min:100,max:200}]}};async function g(e){try{try{await o.Z}catch(e){return console.warn("MongoDB connection failed, using test data:",e),m.NextResponse.json({success:!0,rewards:[{type:"coins",amount:150},{type:"stars",amount:.05}],user:{magnumCoins:850,stars:.55,energy:100}})}let{telegramId:t,caseType:r}=await e.json();if(!t||!r)return m.NextResponse.json({error:"Telegram ID and case type are required"},{status:400});let n=c[r];if(!n)return m.NextResponse.json({error:"Invalid case type"},{status:400});let a=await u.Z.findOne({telegramId:t});if(!a)return m.NextResponse.json({error:"User not found"},{status:404});if(a.magnumCoins<n.price)return m.NextResponse.json({error:"Insufficient funds"},{status:400});let s=n.rewards.map(e=>({type:e.type,amount:Math.random()*(e.max-e.min)+e.min}));a.magnumCoins-=n.price,s.forEach(e=>{"coins"===e.type?a.magnumCoins+=Math.floor(e.amount):"stars"===e.type?a.stars+=e.amount:"energy"===e.type&&(a.energy=Math.min(a.maxEnergy,a.energy+Math.floor(e.amount)))}),await a.save();let i=new y({userId:t,caseType:r,caseName:n.name,price:n.price,rewards:s});return await i.save(),m.NextResponse.json({success:!0,rewards:s,user:{magnumCoins:a.magnumCoins,stars:a.stars,energy:a.energy}})}catch(e){return console.error("Error opening case:",e),m.NextResponse.json({error:"Internal server error"},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/cases/open/route",pathname:"/api/cases/open",filename:"route",bundlePath:"app/api/cases/open/route"},resolvedPagePath:"C:\\Users\\matvi\\OneDrive\\Рабочий стол\\MagnumStarBot-1\\app\\api\\cases\\open\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:x,staticGenerationAsyncStorage:N,serverHooks:b}=f,v="/api/cases/open/route";function w(){return(0,i.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:N})}},2690:(e,t,r)=>{r.d(t,{Z:()=>i});var n=r(1185),a=r.n(n);let s=new n.Schema({telegramId:{type:Number,required:!0,unique:!0},username:{type:String},firstName:{type:String},lastName:{type:String},magnumCoins:{type:Number,default:100,min:0},stars:{type:Number,default:0,min:0},energy:{type:Number,default:100,min:0},maxEnergy:{type:Number,default:100,min:1},totalClicks:{type:Number,default:0,min:0},level:{type:Number,default:1,min:1},experience:{type:Number,default:0,min:0},experienceToNext:{type:Number,default:100,min:1},lastEnergyRestore:{type:Date,default:Date.now},clickPower:{type:Number,default:1,min:1},upgrades:[{id:{type:String,required:!0},level:{type:Number,default:0,min:0}}],statistics:{totalEarned:{type:Number,default:0,min:0},totalSpent:{type:Number,default:0,min:0},casesOpened:{type:Number,default:0,min:0},rareItemsFound:{type:Number,default:0,min:0},daysPlayed:{type:Number,default:1,min:1},maxClickStreak:{type:Number,default:0,min:0},currentClickStreak:{type:Number,default:0,min:0},prestigeCount:{type:Number,default:0,min:0}}},{timestamps:!0});s.index({telegramId:1}),s.index({level:-1}),s.index({magnumCoins:-1});let i=a().models.User||a().model("User",s)},6039:(e,t,r)=>{let n;r.d(t,{Z:()=>i,N:()=>m});let a=require("mongodb");if(!process.env.MONGODB_URI)throw Error('Invalid/Missing environment variable: "MONGODB_URI"');let s=process.env.MONGODB_URI,i=n=new a.MongoClient(s,{}).connect();async function m(){return(await n).db("magnum_clicker")}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,972],()=>r(7883));module.exports=n})();